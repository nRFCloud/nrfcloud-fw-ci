name: Build
permissions:
  actions: read
  contents: read
  id-token: write  # Only if you use OIDC for authentication

on:
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage to build'
        required: true
        default: 'prod'
        type: string
      ncs-commit:
        description: 'NCS commit to build'
        required: true
        default: 'main'
        type: string
      device:
        description: 'Device to build for'
        required: true
        default: 'thingy91x'
        type: string
      group:
        description: 'Build group'
        required: true
        default: 'coap'
        type: string
  workflow_call:
    inputs:
      stage:
        description: 'Stage to build'
        required: true
        default: 'prod'
        type: string
      ncs-commit:
        description: 'NCS commit to build'
        required: true
        default: 'main'
        type: string
      device:
        description: 'Device to build for'
        required: true
        default: 'thingy91x'
        type: string
      group:
        description: 'Build group'
        required: true
        default: 'coap'
        type: string
    outputs:
      run_id:
        description: The run ID of the workflow to fetch artifacts from
        value: ${{ jobs.build.outputs.run_id }}
      version:
        description: The version of the firmware built on this run_id
        value: ${{ jobs.get-cached-artifacts.outputs.version }}

jobs:
  get-cached-artifacts:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
      cache-hit: ${{ steps.check-s3-cache.outputs.cache-hit }}
    steps:
      - name: Checkout CI
        uses: actions/checkout@v4
        with:
          path: nrf-cloud-fw-ci

      - name: Checkout NRF
        uses: actions/checkout@v4
        with:
          repository: nrfconnect/sdk-nrf
          ref: ${{ inputs.ncs-commit }}
          path: nrf

      - name: Set BUILD_WORKFLOW_SHA
        working-directory: nrf-cloud-fw-ci
        run: echo "BUILD_WORKFLOW_SHA=$(sha256sum .github/workflows/build.yml | cut -c1-8)" >> $GITHUB_ENV

      - name: create version string
        working-directory: nrf
        id: set-version
        run: |
          NRFSDK_SHA=$(git rev-parse HEAD)
          echo "version=build-${{ env.BUILD_WORKFLOW_SHA }}-$NRFSDK_SHA-${{ inputs.stage }}-${{ inputs.device }}-${{ inputs.group }}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: eu-north-1
          role-duration-seconds: 3600  # 1 hour
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/ci-s3-access

      - name: Try downloading cached artifacts
        id: check-s3-cache
        env:
          VERSION: ${{ steps.set-version.outputs.version }}
          S3_BUCKET: nrfcloud-fw-ci-build-cache
        run: |
          # Try to download cached artifacts from S3
          echo "Checking for cached build: $VERSION"
          
          if aws s3 ls "s3://$S3_BUCKET/$VERSION.zip" 2>/dev/null; then
            echo "Found cached artifacts in S3, downloading..."
            aws s3 cp "s3://$S3_BUCKET/$VERSION.zip" "$VERSION.zip"
            
            # Extract the zip file
            mkdir -p artifacts
            unzip -q "$VERSION.zip" -d artifacts
            
            echo "cache-hit=true" >> $GITHUB_OUTPUT
            echo "Successfully downloaded and extracted cached artifacts"
          else
            echo "No cached artifacts found in S3"
            echo "cache-hit=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload cached artifacts to GitHub Actions
        if: steps.check-s3-cache.outputs.cache-hit == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.set-version.outputs.version }}
          path: artifacts
          retention-days: 7
      
  build:
    needs: get-cached-artifacts
    if: needs.get-cached-artifacts.outputs.cache-hit != 'true'
    runs-on: build_self_hosted
    container: ghcr.io/zephyrproject-rtos/ci:v0.27.4
    env:
      CMAKE_PREFIX_PATH: /opt/toolchains
    outputs:
      run_id: ${{ github.run_id }}
    steps:
      - name: Set VERSION variable
        run: echo "VERSION=${{ needs.get-cached-artifacts.outputs.version }}" >> $GITHUB_ENV

      - name: Checkout CI
        uses: actions/checkout@v4
        with:
          path: nrf-cloud-fw-ci

      - name: Checkout NRF
        uses: actions/checkout@v4
        with:
          repository: nrfconnect/sdk-nrf
          ref: ${{ inputs.ncs-commit }}
          path: nrf

      - name: Check if build exists in cache
        id: cache-check
        run: |
          if [ -d "artifact-cache/$VERSION" ]; then
            echo "cache-hit=true" >> $GITHUB_OUTPUT
            echo "Build $VERSION found in cache, skipping build steps"
          else
            echo "cache-hit=false" >> $GITHUB_OUTPUT
            echo "Build $VERSION not found in cache, proceeding with build"
          fi

      - name: Restore from cache
        if: steps.cache-check.outputs.cache-hit == 'true'
        run: |
          mkdir -p $VERSION/artifacts
          cp -r artifact-cache/$VERSION/* $VERSION/artifacts
          echo "Restored build $VERSION from cache"

      - name: Initialize Workspace
        if: steps.cache-check.outputs.cache-hit == 'false'
        working-directory: nrf
        run: |
          if [ ! -d "../.west" ]; then
            west init -l .
          else
            echo ".west folder already exists, skipping west init."
          fi
          west update -o=--depth=1 -n
          west blobs fetch hal_nordic

      - name: Install dependencies
        if: steps.cache-check.outputs.cache-hit == 'false'
        run: |
          # The Matter IDL is part of requirements-build.txt, but it's not available
          # in pypi so we need to install it from the source code
          MATTER_IDL_PATH=modules/lib/matter/scripts/py_matter_idl
          if [ -d $MATTER_IDL_PATH ]; then
            pip install -e $MATTER_IDL_PATH
          fi
          pip install -r nrf/scripts/requirements-build.txt
          rm -rf artifacts
          mkdir -p artifacts

      - name: Prepare build folder
        if: steps.cache-check.outputs.cache-hit == 'false'
        run: |
          rm -rf build*
          mkdir -p $VERSION

      - name: Set config fragment variables
        if: steps.cache-check.outputs.cache-hit == 'false'
        shell: bash
        run: |
          FRAGMENT_DIR=$PWD/nrf-cloud-fw-ci/config_fragments
          echo "FRAGMENT_DIR=$FRAGMENT_DIR" >> $GITHUB_ENV
          echo "COAP_SERVER_FRAGMENT=$FRAGMENT_DIR/stages_general/coap_${{ inputs.stage }}.conf" >> $GITHUB_ENV
          echo "MQTT_SERVER_FRAGMENT=$FRAGMENT_DIR/stages_general/mqtt_${{ inputs.stage }}.conf" >> $GITHUB_ENV
          echo "REST_SERVER_FRAGMENT=$FRAGMENT_DIR/stages_general/rest_${{ inputs.stage }}.conf" >> $GITHUB_ENV
          echo "COAP_PROVISIONING_SERVER_FRAGMENT=$FRAGMENT_DIR/stages_provisioning/coap_${{ inputs.stage }}.conf" >> $GITHUB_ENV
          echo "HTTP_PROVISIONING_SERVER_FRAGMENT=$FRAGMENT_DIR/stages_provisioning/http_${{ inputs.stage }}.conf" >> $GITHUB_ENV
          echo "DEBUG_LOGS_FRAGMENT=$FRAGMENT_DIR/mss/debug_logs.conf" >> $GITHUB_ENV
          echo "MODEM_LOG_FRAGMENT=$FRAGMENT_DIR/mss/modem_log.conf" >> $GITHUB_ENV
          echo "VERBOSE_ALERT_FRAGMENT=$FRAGMENT_DIR/mss/verbose_alert.conf" >> $GITHUB_ENV
          echo "MSS_AGNSS_ONLY_FRAGMENT=$FRAGMENT_DIR/mss/agnss_only.conf" >> $GITHUB_ENV
          echo "BINARY_LOGS_FRAGMENT=$FRAGMENT_DIR/mss/binary_logs.conf" >> $GITHUB_ENV
          echo "FOTA_APP_FRAGMENT=$FRAGMENT_DIR/mss/fota_app.conf" >> $GITHUB_ENV
          echo "FOTA_BOOT_FRAGMENT=$FRAGMENT_DIR/mss/fota_boot.conf" >> $GITHUB_ENV
          echo "FOTA_MODEM_FULL_FRAGMENT=$FRAGMENT_DIR/mss/fota_modem_full.conf" >> $GITHUB_ENV
          echo "MSS_PGPS_ONLY_FRAGMENT=$FRAGMENT_DIR/mss/pgps_only.conf" >> $GITHUB_ENV
          echo "MSS_PGPS_EXT_FRAGMENT=$FRAGMENT_DIR/mss/pgps_ext.conf" >> $GITHUB_ENV
          echo "PROVISIONING_FRAGMENT=$FRAGMENT_DIR/mss/provisioning.conf" >> $GITHUB_ENV

      - name: Build CoAP samples
        if: inputs.group == 'coap' && steps.cache-check.outputs.cache-hit == 'false'
        shell: bash
        run: |
          # Thingy:91 X
          if [[ "${{ inputs.device }}" == "thingy91x" ]]; then
            west build -b thingy91x/nrf9151/ns --build-dir $VERSION/thingy91x-nrf_cloud_coap_device_message        nrf/samples/cellular/nrf_cloud_coap_device_message  -- -DEXTRA_CONF_FILE=$COAP_SERVER_FRAGMENT -Dnrf_cloud_coap_device_message_SNIPPET=nrf91-modem-trace-uart
            west build -b thingy91x/nrf9151/ns --build-dir $VERSION/thingy91x-nrf_cloud_coap_cell_location         nrf/samples/cellular/nrf_cloud_coap_cell_location   -- -DEXTRA_CONF_FILE=$COAP_SERVER_FRAGMENT -Dnrf_cloud_coap_cell_location_SNIPPET=nrf91-modem-trace-uart
            west build -b thingy91x/nrf9151/ns --build-dir $VERSION/thingy91x-nrf_cloud_coap_fota                  nrf/samples/cellular/nrf_cloud_coap_fota            -- -DEXTRA_CONF_FILE=$COAP_SERVER_FRAGMENT -Dnrf_cloud_coap_fota_SNIPPET=nrf91-modem-trace-uart
            sed -i 's/^EXTRAVERSION =.*/EXTRAVERSION = fotatest/' nrf/samples/cellular/nrf_cloud_coap_fota/VERSION
            west build -b thingy91x/nrf9151/ns --build-dir $VERSION/thingy91x-nrf_cloud_coap_fota_fmfu             nrf/samples/cellular/nrf_cloud_coap_fota            -- -DEXTRA_CONF_FILE="full_modem_fota.conf;$COAP_SERVER_FRAGMENT" -Dnrf_cloud_coap_fota_SNIPPET=nrf91-modem-trace-uart
          fi
          # Thingy:91
          if [[ "${{ inputs.device }}" == "thingy91" ]]; then
            west build -b thingy91/nrf9160/ns --build-dir $VERSION/thingy91-nrf_cloud_coap_device_message        nrf/samples/cellular/nrf_cloud_coap_device_message  -- -DEXTRA_CONF_FILE=$COAP_SERVER_FRAGMENT -Dnrf_cloud_coap_device_message_SNIPPET=nrf91-modem-trace-uart
            west build -b thingy91/nrf9160/ns --build-dir $VERSION/thingy91-nrf_cloud_coap_cell_location         nrf/samples/cellular/nrf_cloud_coap_cell_location   -- -DEXTRA_CONF_FILE=$COAP_SERVER_FRAGMENT -Dnrf_cloud_coap_cell_location_SNIPPET=nrf91-modem-trace-uart
            west build -b thingy91/nrf9160/ns --build-dir $VERSION/thingy91-nrf_cloud_coap_fota                  nrf/samples/cellular/nrf_cloud_coap_fota            -- -DEXTRA_CONF_FILE=$COAP_SERVER_FRAGMENT -Dnrf_cloud_coap_fota_SNIPPET=nrf91-modem-trace-uart -DSB_CONFIG_SECURE_BOOT_APPCORE=n -DCONFIG_SECURE_BOOT=n
            sed -i 's/^EXTRAVERSION =.*/EXTRAVERSION = fotatest/' nrf/samples/cellular/nrf_cloud_coap_fota/VERSION
            west build -b thingy91/nrf9160/ns --build-dir $VERSION/thingy91-nrf_cloud_coap_fota_test             nrf/samples/cellular/nrf_cloud_coap_fota            -- -DEXTRA_CONF_FILE=$COAP_SERVER_FRAGMENT -Dnrf_cloud_coap_fota_SNIPPET=nrf91-modem-trace-uart -DSB_CONFIG_SECURE_BOOT_APPCORE=n -DCONFIG_SECURE_BOOT=n
          fi
          # nRF9160-DK
          if [[ "${{ inputs.device }}" == "nrf9160dk" ]]; then
            west build -b nrf9160dk/nrf9160/ns --build-dir $VERSION/nrf9160dk-nrf_cloud_coap_device_message        nrf/samples/cellular/nrf_cloud_coap_device_message  -- -DEXTRA_CONF_FILE=$COAP_SERVER_FRAGMENT -Dnrf_cloud_coap_device_message_SNIPPET=nrf91-modem-trace-uart
            west build -b nrf9160dk/nrf9160/ns --build-dir $VERSION/nrf9160dk-nrf_cloud_coap_cell_location         nrf/samples/cellular/nrf_cloud_coap_cell_location   -- -DEXTRA_CONF_FILE=$COAP_SERVER_FRAGMENT -Dnrf_cloud_coap_cell_location_SNIPPET=nrf91-modem-trace-uart
            west build -b nrf9160dk/nrf9160/ns --build-dir $VERSION/nrf9160dk-nrf_cloud_coap_fota                  nrf/samples/cellular/nrf_cloud_coap_fota            -- -DEXTRA_CONF_FILE=$COAP_SERVER_FRAGMENT -Dnrf_cloud_coap_fota_SNIPPET=nrf91-modem-trace-uart
            sed -i 's/^EXTRAVERSION =.*/EXTRAVERSION = fotatest/' nrf/samples/cellular/nrf_cloud_coap_fota/VERSION
            west build -b nrf9160dk/nrf9160/ns --build-dir $VERSION/nrf9160dk-nrf_cloud_coap_fota_fmfu             nrf/samples/cellular/nrf_cloud_coap_fota            -- -DEXTRA_CONF_FILE="full_modem_fota.conf;$COAP_SERVER_FRAGMENT" -Dnrf_cloud_coap_fota_SNIPPET=nrf91-modem-trace-uart
          fi
          # nRF9151-DK
          if [[ "${{ inputs.device }}" == "nrf9151dk" ]]; then
            west build -b nrf9151dk/nrf9151/ns --build-dir $VERSION/nrf9151dk-nrf_cloud_coap_device_message        nrf/samples/cellular/nrf_cloud_coap_device_message  -- -DEXTRA_CONF_FILE=$COAP_SERVER_FRAGMENT -Dnrf_cloud_coap_device_message_SNIPPET=nrf91-modem-trace-uart
            west build -b nrf9151dk/nrf9151/ns --build-dir $VERSION/nrf9151dk-nrf_cloud_coap_cell_location         nrf/samples/cellular/nrf_cloud_coap_cell_location   -- -DEXTRA_CONF_FILE=$COAP_SERVER_FRAGMENT -Dnrf_cloud_coap_cell_location_SNIPPET=nrf91-modem-trace-uart
            west build -b nrf9151dk/nrf9151/ns --build-dir $VERSION/nrf9151dk-nrf_cloud_coap_fota                  nrf/samples/cellular/nrf_cloud_coap_fota            -- -DEXTRA_CONF_FILE=$COAP_SERVER_FRAGMENT -Dnrf_cloud_coap_fota_SNIPPET=nrf91-modem-trace-uart
            sed -i 's/^EXTRAVERSION =.*/EXTRAVERSION = fotatest/' nrf/samples/cellular/nrf_cloud_coap_fota/VERSION
            west build -b nrf9151dk/nrf9151/ns --build-dir $VERSION/nrf9151dk-nrf_cloud_coap_fota_fmfu             nrf/samples/cellular/nrf_cloud_coap_fota            -- -DEXTRA_CONF_FILE="full_modem_fota.conf;$COAP_SERVER_FRAGMENT" -Dnrf_cloud_coap_fota_SNIPPET=nrf91-modem-trace-uart
          fi

      - name: Build REST samples
        if: inputs.group == 'rest' && steps.cache-check.outputs.cache-hit == 'false'
        shell: bash
        run: |
          # Thingy:91 X
          if [[ "${{ inputs.device }}" == "thingy91x" ]]; then
            west build -b thingy91x/nrf9151/ns --build-dir $VERSION/thingy91x-nrf_cloud_rest_device_message        nrf/samples/cellular/nrf_cloud_rest_device_message  -- -DEXTRA_CONF_FILE=$REST_SERVER_FRAGMENT -Dnrf_cloud_rest_device_message_SNIPPET=nrf91-modem-trace-uart
            west build -b thingy91x/nrf9151/ns --build-dir $VERSION/thingy91x-nrf_cloud_rest_cell_location         nrf/samples/cellular/nrf_cloud_rest_cell_location   -- -DEXTRA_CONF_FILE=$REST_SERVER_FRAGMENT -Dnrf_cloud_rest_cell_location_SNIPPET=nrf91-modem-trace-uart
            west build -b thingy91x/nrf9151/ns --build-dir $VERSION/thingy91x-nrf_cloud_rest_fota                  nrf/samples/cellular/nrf_cloud_rest_fota            -- -DEXTRA_CONF_FILE=$REST_SERVER_FRAGMENT -Dnrf_cloud_rest_fota_SNIPPET=nrf91-modem-trace-uart
            west build -b thingy91x/nrf9151/ns --build-dir $VERSION/thingy91x-nrf_cloud_rest_fota_fmfu             nrf/samples/cellular/nrf_cloud_rest_fota            -- -DEXTRA_CONF_FILE="overlay_full_modem_fota.conf;$REST_SERVER_FRAGMENT" -Dnrf_cloud_rest_fota_SNIPPET=nrf91-modem-trace-uart '-DCONFIG_REST_FOTA_SAMPLE_VERSION="1.0.0-fotatest"'
          fi
          # Thingy:91
          if [[ "${{ inputs.device }}" == "thingy91" ]]; then
            # TODO: missing t91 overlay/fragment for device message (thanks CAF!)
            # west build -b thingy91/nrf9160/ns --build-dir $VERSION/thingy91-nrf_cloud_rest_device_message        nrf/samples/cellular/nrf_cloud_rest_device_message  -- -DEXTRA_CONF_FILE=$REST_SERVER_FRAGMENT -Dnrf_cloud_rest_device_message_SNIPPET=nrf91-modem-trace-uart
            west build -b thingy91/nrf9160/ns --build-dir $VERSION/thingy91-nrf_cloud_rest_cell_location         nrf/samples/cellular/nrf_cloud_rest_cell_location   -- -DEXTRA_CONF_FILE=$REST_SERVER_FRAGMENT -Dnrf_cloud_rest_cell_location_SNIPPET=nrf91-modem-trace-uart
            west build -b thingy91/nrf9160/ns --build-dir $VERSION/thingy91-nrf_cloud_rest_fota                  nrf/samples/cellular/nrf_cloud_rest_fota            -- -DEXTRA_CONF_FILE=$REST_SERVER_FRAGMENT -Dnrf_cloud_rest_fota_SNIPPET=nrf91-modem-trace-uart -DSB_CONFIG_SECURE_BOOT_APPCORE=n -DCONFIG_SECURE_BOOT=n
            west build -b thingy91/nrf9160/ns --build-dir $VERSION/thingy91-nrf_cloud_rest_fota_test             nrf/samples/cellular/nrf_cloud_rest_fota            -- -DEXTRA_CONF_FILE=$REST_SERVER_FRAGMENT -Dnrf_cloud_rest_fota_SNIPPET=nrf91-modem-trace-uart -DSB_CONFIG_SECURE_BOOT_APPCORE=n -DCONFIG_SECURE_BOOT=n '-DCONFIG_REST_FOTA_SAMPLE_VERSION="1.0.0-fotatest"'
          fi
          # nRF9160-DK
          if [[ "${{ inputs.device }}" == "nrf9160dk" ]]; then
            west build -b nrf9160dk/nrf9160/ns --build-dir $VERSION/nrf9160dk-nrf_cloud_rest_device_message        nrf/samples/cellular/nrf_cloud_rest_device_message  -- -DEXTRA_CONF_FILE=$REST_SERVER_FRAGMENT -Dnrf_cloud_rest_device_message_SNIPPET=nrf91-modem-trace-uart
            west build -b nrf9160dk/nrf9160/ns --build-dir $VERSION/nrf9160dk-nrf_cloud_rest_cell_location         nrf/samples/cellular/nrf_cloud_rest_cell_location   -- -DEXTRA_CONF_FILE=$REST_SERVER_FRAGMENT -Dnrf_cloud_rest_cell_location_SNIPPET=nrf91-modem-trace-uart
            west build -b nrf9160dk/nrf9160/ns --build-dir $VERSION/nrf9160dk-nrf_cloud_rest_fota                  nrf/samples/cellular/nrf_cloud_rest_fota            -- -DEXTRA_CONF_FILE=$REST_SERVER_FRAGMENT -Dnrf_cloud_rest_fota_SNIPPET=nrf91-modem-trace-uart
            west build -b nrf9160dk/nrf9160/ns --build-dir $VERSION/nrf9160dk-nrf_cloud_rest_fota_fmfu             nrf/samples/cellular/nrf_cloud_rest_fota            -- -DEXTRA_CONF_FILE="overlay_full_modem_fota.conf;$REST_SERVER_FRAGMENT" -Dnrf_cloud_rest_fota_SNIPPET=nrf91-modem-trace-uart '-DCONFIG_REST_FOTA_SAMPLE_VERSION="1.0.0-fotatest"'
          fi
          # nRF9151-DK
          if [[ "${{ inputs.device }}" == "nrf9151dk" ]]; then
            west build -b nrf9151dk/nrf9151/ns --build-dir $VERSION/nrf9151dk-nrf_cloud_rest_device_message        nrf/samples/cellular/nrf_cloud_rest_device_message  -- -DEXTRA_CONF_FILE=$REST_SERVER_FRAGMENT -Dnrf_cloud_rest_device_message_SNIPPET=nrf91-modem-trace-uart
            west build -b nrf9151dk/nrf9151/ns --build-dir $VERSION/nrf9151dk-nrf_cloud_rest_cell_location         nrf/samples/cellular/nrf_cloud_rest_cell_location   -- -DEXTRA_CONF_FILE=$REST_SERVER_FRAGMENT -Dnrf_cloud_rest_cell_location_SNIPPET=nrf91-modem-trace-uart
            west build -b nrf9151dk/nrf9151/ns --build-dir $VERSION/nrf9151dk-nrf_cloud_rest_fota                  nrf/samples/cellular/nrf_cloud_rest_fota            -- -DEXTRA_CONF_FILE=$REST_SERVER_FRAGMENT -Dnrf_cloud_rest_fota_SNIPPET=nrf91-modem-trace-uart
            west build -b nrf9151dk/nrf9151/ns --build-dir $VERSION/nrf9151dk-nrf_cloud_rest_fota_fmfu             nrf/samples/cellular/nrf_cloud_rest_fota            -- -DEXTRA_CONF_FILE="overlay_full_modem_fota.conf;$REST_SERVER_FRAGMENT" -Dnrf_cloud_rest_fota_SNIPPET=nrf91-modem-trace-uart '-DCONFIG_REST_FOTA_SAMPLE_VERSION="1.0.0-fotatest"'
          fi

      - name: Build MQTT samples
        if: inputs.group == 'mqtt' && steps.cache-check.outputs.cache-hit == 'false'
        shell: bash
        run: |
          # Thingy:91 X
          if [[ "${{ inputs.device }}" == "thingy91x" ]]; then
            west build -b thingy91x/nrf9151/ns --build-dir $VERSION/thingy91x-nrf_cloud_mqtt_device_message        nrf/samples/cellular/nrf_cloud_mqtt_device_message  -- -DEXTRA_CONF_FILE=$MQTT_SERVER_FRAGMENT -Dnrf_cloud_mqtt_device_message_SNIPPET=nrf91-modem-trace-uart
            west build -b thingy91x/nrf9151/ns --build-dir $VERSION/thingy91x-nrf_cloud_mqtt_cell_location         nrf/samples/cellular/nrf_cloud_mqtt_cell_location   -- -DEXTRA_CONF_FILE=$MQTT_SERVER_FRAGMENT -Dnrf_cloud_mqtt_cell_location_SNIPPET=nrf91-modem-trace-uart
            west build -b thingy91x/nrf9151/ns --build-dir $VERSION/thingy91x-nrf_cloud_mqtt_fota                  nrf/samples/cellular/nrf_cloud_mqtt_fota            -- -DEXTRA_CONF_FILE=$MQTT_SERVER_FRAGMENT -Dnrf_cloud_mqtt_fota_SNIPPET=nrf91-modem-trace-uart
            sed -i 's/^EXTRAVERSION =.*/EXTRAVERSION = fotatest/' nrf/samples/cellular/nrf_cloud_mqtt_fota/VERSION
            west build -b thingy91x/nrf9151/ns --build-dir $VERSION/thingy91x-nrf_cloud_mqtt_fota_fmfu             nrf/samples/cellular/nrf_cloud_mqtt_fota            -- -DEXTRA_CONF_FILE="full_modem_fota.conf;$MQTT_SERVER_FRAGMENT" -Dnrf_cloud_mqtt_fota_SNIPPET=nrf91-modem-trace-uart
          fi
          # Thingy:91
          if [[ "${{ inputs.device }}" == "thingy91" ]]; then
            west build -b thingy91/nrf9160/ns --build-dir $VERSION/thingy91-nrf_cloud_mqtt_device_message          nrf/samples/cellular/nrf_cloud_mqtt_device_message  -- -DEXTRA_CONF_FILE=$MQTT_SERVER_FRAGMENT -Dnrf_cloud_mqtt_device_message_SNIPPET=nrf91-modem-trace-uart
            west build -b thingy91/nrf9160/ns --build-dir $VERSION/thingy91-nrf_cloud_mqtt_cell_location         nrf/samples/cellular/nrf_cloud_mqtt_cell_location   -- -DEXTRA_CONF_FILE=$MQTT_SERVER_FRAGMENT -Dnrf_cloud_mqtt_cell_location_SNIPPET=nrf91-modem-trace-uart
            west build -b thingy91/nrf9160/ns --build-dir $VERSION/thingy91-nrf_cloud_mqtt_fota                  nrf/samples/cellular/nrf_cloud_mqtt_fota            -- -DEXTRA_CONF_FILE=$MQTT_SERVER_FRAGMENT -Dnrf_cloud_mqtt_fota_SNIPPET=nrf91-modem-trace-uart -DSB_CONFIG_SECURE_BOOT_APPCORE=n -DCONFIG_SECURE_BOOT=n
            sed -i 's/^EXTRAVERSION =.*/EXTRAVERSION = fotatest/' nrf/samples/cellular/nrf_cloud_mqtt_fota/VERSION
            west build -b thingy91/nrf9160/ns --build-dir $VERSION/thingy91-nrf_cloud_mqtt_fota_test             nrf/samples/cellular/nrf_cloud_mqtt_fota            -- -DEXTRA_CONF_FILE=$MQTT_SERVER_FRAGMENT -Dnrf_cloud_mqtt_fota_SNIPPET=nrf91-modem-trace-uart -DSB_CONFIG_SECURE_BOOT_APPCORE=n -DCONFIG_SECURE_BOOT=n
          fi
          # nRF9160-DK
          if [[ "${{ inputs.device }}" == "nrf9160dk" ]]; then
            west build -b nrf9160dk/nrf9160/ns --build-dir $VERSION/nrf9160dk-nrf_cloud_mqtt_device_message        nrf/samples/cellular/nrf_cloud_mqtt_device_message  -- -DEXTRA_CONF_FILE=$MQTT_SERVER_FRAGMENT -Dnrf_cloud_mqtt_device_message_SNIPPET=nrf91-modem-trace-uart
            west build -b nrf9160dk/nrf9160/ns --build-dir $VERSION/nrf9160dk-nrf_cloud_mqtt_cell_location         nrf/samples/cellular/nrf_cloud_mqtt_cell_location   -- -DEXTRA_CONF_FILE=$MQTT_SERVER_FRAGMENT -Dnrf_cloud_mqtt_cell_location_SNIPPET=nrf91-modem-trace-uart
            west build -b nrf9160dk/nrf9160/ns --build-dir $VERSION/nrf9160dk-nrf_cloud_mqtt_fota                  nrf/samples/cellular/nrf_cloud_mqtt_fota            -- -DEXTRA_CONF_FILE=$MQTT_SERVER_FRAGMENT -Dnrf_cloud_mqtt_fota_SNIPPET=nrf91-modem-trace-uart
            sed -i 's/^EXTRAVERSION =.*/EXTRAVERSION = fotatest/' nrf/samples/cellular/nrf_cloud_mqtt_fota/VERSION
            west build -b nrf9160dk/nrf9160/ns --build-dir $VERSION/nrf9160dk-nrf_cloud_mqtt_fota_fmfu             nrf/samples/cellular/nrf_cloud_mqtt_fota            -- -DEXTRA_CONF_FILE="full_modem_fota.conf;$MQTT_SERVER_FRAGMENT" -Dnrf_cloud_mqtt_fota_SNIPPET=nrf91-modem-trace-uart
          fi
          # nRF9151-DK
          if [[ "${{ inputs.device }}" == "nrf9151dk" ]]; then
            west build -b nrf9151dk/nrf9151/ns --build-dir $VERSION/nrf9151dk-nrf_cloud_mqtt_device_message        nrf/samples/cellular/nrf_cloud_mqtt_device_message  -- -DEXTRA_CONF_FILE=$MQTT_SERVER_FRAGMENT -Dnrf_cloud_mqtt_device_message_SNIPPET=nrf91-modem-trace-uart
            west build -b nrf9151dk/nrf9151/ns --build-dir $VERSION/nrf9151dk-nrf_cloud_mqtt_cell_location         nrf/samples/cellular/nrf_cloud_mqtt_cell_location   -- -DEXTRA_CONF_FILE=$MQTT_SERVER_FRAGMENT -Dnrf_cloud_mqtt_cell_location_SNIPPET=nrf91-modem-trace-uart
            west build -b nrf9151dk/nrf9151/ns --build-dir $VERSION/nrf9151dk-nrf_cloud_mqtt_fota                  nrf/samples/cellular/nrf_cloud_mqtt_fota            -- -DEXTRA_CONF_FILE=$MQTT_SERVER_FRAGMENT -Dnrf_cloud_mqtt_fota_SNIPPET=nrf91-modem-trace-uart
            sed -i 's/^EXTRAVERSION =.*/EXTRAVERSION = fotatest/' nrf/samples/cellular/nrf_cloud_mqtt_fota/VERSION
            west build -b nrf9151dk/nrf9151/ns --build-dir $VERSION/nrf9151dk-nrf_cloud_mqtt_fota_fmfu             nrf/samples/cellular/nrf_cloud_mqtt_fota            -- -DEXTRA_CONF_FILE="full_modem_fota.conf;$MQTT_SERVER_FRAGMENT" -Dnrf_cloud_mqtt_fota_SNIPPET=nrf91-modem-trace-uart
          fi

      - name: Build MSS COAP
        if: inputs.group == 'mss-coap' && steps.cache-check.outputs.cache-hit == 'false'
        shell: bash
        run: |
          # nRF9160-DK
          if [[ "${{ inputs.device }}" == "nrf9160dk" ]]; then
            west build -b nrf9160dk/nrf9160/ns       --build-dir $VERSION/nrf9160dk-nrf_cloud_multi_service_coap_agnss_only      nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$MSS_AGNSS_ONLY_FRAGMENT" -DCONFIG_NRF_CLOUD_COAP_LOG_LEVEL_DBG=y
            west build -b nrf9160dk/nrf9160/ns       --build-dir $VERSION/nrf9160dk-nrf_cloud_multi_service_coap_binary_log      nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;overlay_nrfcloud_logging.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$BINARY_LOGS_FRAGMENT"
            west build -b nrf9160dk/nrf9160/ns       --build-dir $VERSION/nrf9160dk-nrf_cloud_multi_service_coap_fota_app_a      nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_APP_FRAGMENT" -DCONFIG_COAP_FOTA_JOB_CHECK_RATE_MINUTES=1
            west build -b nrf9160dk/nrf9160/ns       --build-dir $VERSION/nrf9160dk-nrf_cloud_multi_service_coap_fota_app_b      nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_APP_FRAGMENT" -DCONFIG_COAP_FOTA_JOB_CHECK_RATE_MINUTES=1 '-DCONFIG_APP_VERSION="1.0.0-FOTA-TEST"'
            west build -b nrf9160dk/nrf9160/ns       --build-dir $VERSION/nrf9160dk-nrf_cloud_multi_service_coap_fota_boot_a     nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_BOOT_FRAGMENT" -DCONFIG_COAP_FOTA_JOB_CHECK_RATE_MINUTES=1 -DCONFIG_FW_INFO_FIRMWARE_VERSION=4 -DSB_CONFIG_SECURE_BOOT_APPCORE=y
            west build -b nrf9160dk/nrf9160/ns       --build-dir $VERSION/nrf9160dk-nrf_cloud_multi_service_coap_fota_boot_b     nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_BOOT_FRAGMENT" -DCONFIG_COAP_FOTA_JOB_CHECK_RATE_MINUTES=1 -DCONFIG_FW_INFO_FIRMWARE_VERSION=5 -DSB_CONFIG_SECURE_BOOT_APPCORE=y
            west build -b nrf9160dk@1.1.0/nrf9160/ns --build-dir $VERSION/nrf9160dk-nrf_cloud_multi_service_coap_fota_modem_full nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_full_modem_fota.conf;overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_MODEM_FULL_FRAGMENT" -DCONFIG_COAP_FOTA_JOB_CHECK_RATE_MINUTES=1
            west build -b nrf9160dk/nrf9160/ns       --build-dir $VERSION/nrf9160dk-nrf_cloud_multi_service_coap_min             nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_min_coap.conf;$COAP_SERVER_FRAGMENT"
            west build -b nrf9160dk/nrf9160/ns       --build-dir $VERSION/nrf9160dk-nrf_cloud_multi_service_coap_no_gnss         nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT" -DCONFIG_LOCATION_METHOD_GNSS=n
            west build -b nrf9160dk/nrf9160/ns       --build-dir $VERSION/nrf9160dk-nrf_cloud_multi_service_coap_pgps_only       nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$MSS_PGPS_ONLY_FRAGMENT" -DCONFIG_NRF_CLOUD_COAP_LOG_LEVEL_DBG=y
            west build -b nrf9160dk/nrf9160/ns       --build-dir $VERSION/nrf9160dk-nrf_cloud_multi_service_coap_text_log        nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;overlay_nrfcloud_logging.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$VERBOSE_ALERT_FRAGMENT"
          fi
          # nRF9151-DK
          if [[ "${{ inputs.device }}" == "nrf9151dk" ]]; then
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_coap_onboard_coap    nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay-coap_nrf_provisioning.conf;overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$PROVISIONING_FRAGMENT;$COAP_PROVISIONING_SERVER_FRAGMENT"
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_coap_onboard_http    nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay-http_nrf_provisioning.conf;overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$PROVISIONING_FRAGMENT;$HTTP_PROVISIONING_SERVER_FRAGMENT"
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_coap_agnss_only      nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$MSS_AGNSS_ONLY_FRAGMENT"
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_coap_binary_log      nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;overlay_nrfcloud_logging.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$BINARY_LOGS_FRAGMENT"
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_coap_fota_app_a      nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_APP_FRAGMENT" -DCONFIG_COAP_FOTA_JOB_CHECK_RATE_MINUTES=1
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_coap_fota_app_b      nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_APP_FRAGMENT" -DCONFIG_COAP_FOTA_JOB_CHECK_RATE_MINUTES=1 '-DCONFIG_APP_VERSION="1.0.0-FOTA-TEST"'
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_coap_fota_boot_a     nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_BOOT_FRAGMENT" -DCONFIG_COAP_FOTA_JOB_CHECK_RATE_MINUTES=1 -DCONFIG_FW_INFO_FIRMWARE_VERSION=4 -DSB_CONFIG_SECURE_BOOT_APPCORE=y
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_coap_fota_boot_b     nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_BOOT_FRAGMENT" -DCONFIG_COAP_FOTA_JOB_CHECK_RATE_MINUTES=1 -DCONFIG_FW_INFO_FIRMWARE_VERSION=5 -DSB_CONFIG_SECURE_BOOT_APPCORE=y
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_coap_fota_modem_full nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_full_modem_fota.conf;overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_MODEM_FULL_FRAGMENT" -DCONFIG_COAP_FOTA_JOB_CHECK_RATE_MINUTES=1
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_coap_min             nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_min_coap.conf;$COAP_SERVER_FRAGMENT"
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_coap_no_gnss         nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT" -DCONFIG_LOCATION_METHOD_GNSS=n
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_coap_pgps_only       nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$MSS_PGPS_ONLY_FRAGMENT"
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_coap_text_log        nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_coap.conf;overlay_nrfcloud_logging.conf;$COAP_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$VERBOSE_ALERT_FRAGMENT"
          fi

      - name: Build MSS MQTT
        if: inputs.group == 'mss-mqtt' && steps.cache-check.outputs.cache-hit == 'false'
        shell: bash
        run: |
          # nRF9151-DK
          if [[ "${{ inputs.device }}" == "nrf9151dk" ]]; then
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_agnss_only      nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$MSS_AGNSS_ONLY_FRAGMENT"
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_binary_log      nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_nrfcloud_logging.conf;$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$BINARY_LOGS_FRAGMENT"
            # dut_not_on_cloud
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_wrong_sectag    nrf/samples/cellular/nrf_cloud_multi_service   -- -DCONFIG_NRF_CLOUD_SEC_TAG=1337
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_fota_app_a      nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_APP_FRAGMENT"
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_fota_app_b      nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_APP_FRAGMENT" '-DCONFIG_APP_VERSION="1.0.0-FOTA-TEST"'
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_fota_app_ext    nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_mcuboot_ext_flash.conf;$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_MODEM_FULL_FRAGMENT" -DSB_CONF_FILE=sysbuild_ext_flash.conf
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_fota_boot_a     nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_BOOT_FRAGMENT" -DCONFIG_FW_INFO_FIRMWARE_VERSION=4 -DSB_CONFIG_SECURE_BOOT_APPCORE=y
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_fota_boot_b     nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_BOOT_FRAGMENT" -DCONFIG_FW_INFO_FIRMWARE_VERSION=5 -DSB_CONFIG_SECURE_BOOT_APPCORE=y
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_fota_boot_ext_a nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_mcuboot_ext_flash.conf;$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_BOOT_FRAGMENT;$FOTA_MODEM_FULL_FRAGMENT" -DCONFIG_FW_INFO_FIRMWARE_VERSION=4 -DSB_CONFIG_SECURE_BOOT_APPCORE=y -DSB_CONF_FILE=sysbuild_ext_flash.conf
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_fota_boot_ext_b nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_mcuboot_ext_flash.conf;$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_BOOT_FRAGMENT;$FOTA_MODEM_FULL_FRAGMENT" -DCONFIG_FW_INFO_FIRMWARE_VERSION=5 -DSB_CONFIG_SECURE_BOOT_APPCORE=y -DSB_CONF_FILE=sysbuild_ext_flash.conf
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_fota_modem_full nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_full_modem_fota.conf;$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_MODEM_FULL_FRAGMENT"
            # maximum config can use modem_full image
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_min             nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT" -DCONFIG_LOCATION_METHOD_GNSS=n
            # nognss is the same as min
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_pgps_ext        nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_pgps_ext_flash.conf;$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$MSS_PGPS_EXT_FRAGMENT"
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_pgps_only       nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$MSS_PGPS_ONLY_FRAGMENT"
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_onboard_coap    nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay-coap_nrf_provisioning.conf;$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$PROVISIONING_FRAGMENT;$COAP_PROVISIONING_SERVER_FRAGMENT"
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_onboard_http    nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay-http_nrf_provisioning.conf;$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$PROVISIONING_FRAGMENT;$HTTP_PROVISIONING_SERVER_FRAGMENT"
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_text_log        nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay_nrfcloud_logging.conf;$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$VERBOSE_ALERT_FRAGMENT"
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_wifi_pos        nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay-nrf7002ek-wifi-scan-only.conf;$MQTT_SERVER_FRAGMENT;$VERBOSE_ALERT_FRAGMENT" -Dnrf_cloud_multi_service_SHIELD=nrf7002ek_nrf7000 -DSB_CONF_FILE=sysbuild_nrf700x-wifi-scan.conf
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_wifi_pos_app_fota_a        nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay-nrf7002ek-wifi-scan-only.conf;$MQTT_SERVER_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_APP_FRAGMENT" -Dnrf_cloud_multi_service_SHIELD=nrf7002ek_nrf7000 -DSB_CONF_FILE=sysbuild_nrf700x-wifi-scan.conf
            west build -b nrf9151dk/nrf9151/ns       --build-dir $VERSION/nrf9151dk-nrf_cloud_multi_service_mqtt_wifi_pos_app_fota_b        nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="overlay-nrf7002ek-wifi-scan-only.conf;$MQTT_SERVER_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$FOTA_APP_FRAGMENT" -Dnrf_cloud_multi_service_SHIELD=nrf7002ek_nrf7000 -DSB_CONF_FILE=sysbuild_nrf700x-wifi-scan.conf '-DCONFIG_APP_VERSION="1.0.0-FOTA-TEST"'
            # delta fota can use app_a
          fi
          if [[ "${{ inputs.device }}" == "thingy91x" ]]; then
            west build -b thingy91x/nrf9151/ns       --build-dir $VERSION/thingy91x-nrf_cloud_multi_service_mqtt_agnss_only      nrf/samples/cellular/nrf_cloud_multi_service   -- -DEXTRA_CONF_FILE="$MQTT_SERVER_FRAGMENT;$DEBUG_LOGS_FRAGMENT;$MODEM_LOG_FRAGMENT;$VERBOSE_ALERT_FRAGMENT;$MSS_AGNSS_ONLY_FRAGMENT" -Dnrf_cloud_multi_service_SNIPPET=nrf91-modem-trace-uart -DCONFIG_NRF_MODEM_LIB_TRACE_LEVEL_IP_ONLY=y
          fi

      - name: Create Artifact bundle
        if: steps.cache-check.outputs.cache-hit == 'false'
        run: |
          for build_dir in $VERSION/*; do
            if [ -d "$build_dir" ]; then
              bash nrf-cloud-fw-ci/scripts/copy_artifacts.sh "$build_dir" "$VERSION/artifacts"
            fi
          done

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.VERSION }}
          path: ${{ env.VERSION }}/artifacts
          retention-days: 7

  upload-to-s3:
    needs: [get-cached-artifacts, build]
    if: needs.get-cached-artifacts.outputs.cache-hit != 'true'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.get-cached-artifacts.outputs.version }}
      S3_BUCKET: nrfcloud-fw-ci-build-cache
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: eu-north-1
          role-duration-seconds: 3600  # 1 hour
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/ci-s3-access
      
      - name: Download artifacts from build
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.VERSION }}
          path: artifacts
      
      - name: Upload artifacts to S3
        run: |
          # Create zip file from artifacts
          cd artifacts
          zip -r "../$VERSION.zip" .
          cd ..
          
          # Upload to S3
          echo "Uploading $VERSION.zip to S3..."
          aws s3 cp "$VERSION.zip" "s3://$S3_BUCKET/$VERSION.zip"
          
          echo "Successfully uploaded artifacts to S3: s3://$S3_BUCKET/$VERSION.zip"
