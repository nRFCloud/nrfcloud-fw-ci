name: Nightly Tests
permissions:
  actions: read
  contents: read
  id-token: write  # Only if you use OIDC for authentication


on:
  schedule:
    - cron: '0 2 * * *'  # Runs daily at 02:00 UTC
  workflow_dispatch:
    inputs:
      stage:
        description: 'Stage to build'
        default: 'prod'
        type: string
      ncs-commit:
        description: 'NCS commit to build'
        default: 'main'
        type: string
      recover_device:
        description: 'Recover device before testing'
        default: false
        type: boolean
      pytest_marker:
        type: string
        required: false
        default: "not slow"

jobs:
  get-ncs-commit:
    runs-on: ubuntu-24.04
    outputs:
      commit: ${{ steps.get-commit.outputs.commit }}
    steps:
      - name: Get latest commit from sdk-nrf
        shell: bash
        id: get-commit
        run: |
          if [ -z "${{ inputs.ncs-commit }}" ] || [ "${{ inputs.ncs-commit }}" == "main" ]; then
            echo "Fetching latest commit from main branch"
            COMMIT=$(git ls-remote https://github.com/nrfconnect/sdk-nrf.git HEAD | awk '{print $1}')
            echo "Latest sdk-nrf commit: $COMMIT"
          elif [ -z "${{ inputs.ncs-commit }}" ] || [ "${{ inputs.ncs-commit }}" == "stable" ]; then
            COMMIT=4035b457da2f881fb6ba7493ce375057af872fda
            echo "Using known-good commit: $COMMIT"
          else
            COMMIT=${{ inputs.ncs-commit }}
            echo "Using specified commit: ${{ inputs.ncs-commit }}"
          fi
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          # Copy parameters to summary
          echo "# Parameters" >> $GITHUB_STEP_SUMMARY
          echo "* Stage: ${{ inputs.stage }}" >> $GITHUB_STEP_SUMMARY
          echo "* Requested NCS Version: ${{ inputs.ncs-commit }}" >> $GITHUB_STEP_SUMMARY
          echo "* Recover Device: ${{ inputs.recover_device }}" >> $GITHUB_STEP_SUMMARY
          echo "* Pytest Marker: ${{ inputs.pytest_marker }}" >> $GITHUB_STEP_SUMMARY
          echo "* Used NCS Commit: $COMMIT" >> $GITHUB_STEP_SUMMARY

  on-target-test:
    needs: get-ncs-commit
    strategy:
      fail-fast: false
      matrix:
        device: [thingy91x, thingy91, nrf9160dk, nrf9151dk]
        group: [coap, rest, mqtt]
    uses: ./.github/workflows/on-target-test.yml
    with:
      stage: ${{ inputs.stage || 'prod' }}
      ncs-commit: ${{ needs.get-ncs-commit.outputs.commit }}
      device: ${{ matrix.device }}
      recover_device: ${{ inputs.recover_device || false }}
      group: ${{ matrix.group }}
      show_run_details: false
      pytest_marker: ${{ inputs.pytest_marker }}
    secrets: inherit

  create-report:
    needs: on-target-test
    runs-on: ubuntu-24.04
    if: always()
    steps:
      - name: Download all test reports
        uses: actions/download-artifact@v4
        with:
          pattern: test-report-*
          path: test-reports

      - name: Collect and rename test results
        run: |
          mkdir -p combined-results

          # List downloaded artifacts structure for debugging
          echo "Downloaded artifacts structure:"
          ls -la test-reports/

          # Find all test-results.xml files and rename them based on their artifact name
          for artifact_dir in test-reports/test-report-*; do
            if [ -d "$artifact_dir" ]; then
              artifact_name=$(basename "$artifact_dir")
              xml_file="$artifact_dir/results/test-results.xml"
              html_file="$artifact_dir/results/test-results.html"

              if [ -f "$xml_file" ]; then
                # Copy with renamed file based on artifact name
                cp "$xml_file" "combined-results/${artifact_name}.xml"
                echo "Copied: $xml_file -> combined-results/${artifact_name}.xml"
              else
                echo "Warning: No test-results.xml found in $artifact_dir"
              fi

              if [ -f "$html_file" ]; then
                cp "$html_file" "combined-results/${artifact_name}.html"
                echo "Copied: $html_file -> combined-results/${artifact_name}.html"
              else
                echo "Warning: No test-results.html found in $artifact_dir"
              fi
            fi
          done

      - name: Results
        if: ${{ always() }}
        uses: pmeier/pytest-results-action@v0.7.1
        with:
          path: combined-results/*.xml
          summary: true
          fail-on-empty: true
          title: FW Test Results

      - name: Upload combined test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: combined-test-results-${{ needs.get-ncs-commit.outputs.commit }}-${{ inputs.stage || 'prod' }}-${{ github.run_number }}
          retention-days: 7
          path: combined-results/
